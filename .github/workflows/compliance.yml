name: Compliance & Regulatory Checks

on:
  schedule:
    # Run compliance checks monthly on the 1st at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'compliance_config.yaml'
      - 'Compliance_Assessment_Tool.py'
      - 'Regulatory_Compliance_Framework.md'

jobs:
  # GDPR Compliance Check
  gdpr-compliance:
    name: GDPR Compliance Assessment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Run GDPR compliance assessment
      run: |
        if [ -f "Compliance_Assessment_Tool.py" ]; then
          echo "ðŸ“‹ Running GDPR compliance assessment..."
          python Compliance_Assessment_Tool.py \
            --config compliance_config.yaml \
            --frameworks gdpr \
            --output gdpr_compliance_report.txt \
            --format text || echo "Assessment completed with findings"
        fi
      continue-on-error: true
    
    - name: Upload GDPR report
      uses: actions/upload-artifact@v3
      with:
        name: gdpr-compliance-report
        path: gdpr_compliance_report.txt
      if: always()

  # CCPA Compliance Check
  ccpa-compliance:
    name: CCPA Compliance Assessment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Run CCPA compliance assessment
      run: |
        if [ -f "Compliance_Assessment_Tool.py" ]; then
          echo "ðŸ“‹ Running CCPA compliance assessment..."
          python Compliance_Assessment_Tool.py \
            --config compliance_config.yaml \
            --frameworks ccpa \
            --output ccpa_compliance_report.txt \
            --format text || echo "Assessment completed with findings"
        fi
      continue-on-error: true
    
    - name: Upload CCPA report
      uses: actions/upload-artifact@v3
      with:
        name: ccpa-compliance-report
        path: ccpa_compliance_report.txt
      if: always()

  # AI Governance Compliance
  ai-governance:
    name: AI Act Compliance Assessment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Run AI Act compliance assessment
      run: |
        if [ -f "Compliance_Assessment_Tool.py" ]; then
          echo "ðŸ“‹ Running AI Act compliance assessment..."
          python Compliance_Assessment_Tool.py \
            --config compliance_config.yaml \
            --frameworks ai_act \
            --output ai_act_compliance_report.txt \
            --format text || echo "Assessment completed with findings"
        fi
      continue-on-error: true
    
    - name: Upload AI Act report
      uses: actions/upload-artifact@v3
      with:
        name: ai-act-compliance-report
        path: ai_act_compliance_report.txt
      if: always()

  # Comprehensive Compliance Assessment
  comprehensive-compliance:
    name: Comprehensive Compliance Assessment
    runs-on: ubuntu-latest
    needs: [gdpr-compliance, ccpa-compliance, ai-governance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Run comprehensive compliance assessment
      run: |
        if [ -f "Compliance_Assessment_Tool.py" ]; then
          echo "ðŸ“‹ Running comprehensive compliance assessment..."
          python Compliance_Assessment_Tool.py \
            --config compliance_config.yaml \
            --frameworks gdpr ccpa ai_act \
            --output comprehensive_compliance_report.json \
            --format json \
            --export-findings compliance_findings.json || echo "Assessment completed"
        fi
      continue-on-error: true
    
    - name: Generate compliance summary
      run: |
        echo "ðŸ“Š Compliance Assessment Summary"
        echo "================================"
        echo ""
        echo "Framework Results:"
        echo "- GDPR: ${{ needs.gdpr-compliance.result }}"
        echo "- CCPA: ${{ needs.ccpa-compliance.result }}"
        echo "- AI Act: ${{ needs.ai-governance.result }}"
        echo ""
        echo "Target Compliance Score: >95%"
        echo ""
        echo "Review detailed reports in artifacts for:"
        echo "- Compliance gaps"
        echo "- Risk assessment"
        echo "- Remediation recommendations"
        echo "- Regulatory requirements status"
    
    - name: Upload comprehensive reports
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-compliance-reports
        path: |
          comprehensive_compliance_report.json
          compliance_findings.json
      if: always()
    
    - name: Create compliance issue if failures
      uses: actions/github-script@v6
      if: failure()
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Compliance Assessment Failed',
            body: `
              ## Compliance Assessment Alert
              
              The automated compliance assessment has identified issues that require attention.
              
              **Assessment Date:** ${new Date().toISOString()}
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              ### Action Required:
              1. Review the compliance reports in the workflow artifacts
              2. Identify specific compliance gaps
              3. Create remediation tasks
              4. Update compliance documentation
              
              ### Reports Available:
              - GDPR Compliance Report
              - CCPA Compliance Report
              - AI Act Compliance Report
              - Comprehensive Assessment
              - Compliance Findings
              
              **Priority:** High
              **Assignee:** Compliance team
              
              cc: @compliance-team
            `,
            labels: ['compliance', 'regulatory', 'high-priority']
          });
      continue-on-error: true
