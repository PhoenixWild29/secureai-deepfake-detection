# X/Twitter Server-Side Authentication Setup

This guide shows you how to configure server-side X/Twitter authentication so users can paste X links directly in SecureAI Guardian and have the server download videos using authenticated cookies.

## Prerequisites

- Access to your DigitalOcean droplet/server
- A browser with X/Twitter logged in
- SSH access to your server

## Step-by-Step Process

### Step 1: Export X Cookies from Your Browser

#### Option A: Using Chrome Extension (Easiest)

1. **Install "Get cookies.txt LOCALLY" extension:**
   - Go to Chrome Web Store: https://chrome.google.com/webstore/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc
   - Click "Add to Chrome"
   - Click "Add Extension"

2. **Export X cookies:**
   - Go to https://x.com (make sure you're logged in)
   - Click the extension icon in your toolbar
   - Click "Export" button
   - Save the file as `x_cookies.txt` on your computer

#### Option B: Using Firefox Extension

1. **Install "cookies.txt" extension:**
   - Go to Firefox Add-ons: https://addons.mozilla.org/en-US/firefox/addon/cookies-txt/
   - Click "Add to Firefox"

2. **Export X cookies:**
   - Go to https://x.com (make sure you're logged in)
   - Click the extension icon
   - Click "Export" button
   - Save the file as `x_cookies.txt`

#### Option C: Manual Export (Advanced)

If extensions don't work, you can manually export cookies using browser DevTools, but this is more complex. The extension method is recommended.

### Step 2: Upload Cookies File to Server

#### Using SCP (from your local computer):

```bash
# Upload cookies file to server
scp x_cookies.txt root@guardian.secureai.dev:/root/secureai-deepfake-detection/secrets/x_cookies.txt
```

**Your server:** `root@guardian.secureai.dev`

#### Using DigitalOcean Console:

1. **Create the secrets directory on server:**
   ```bash
   ssh root@guardian.secureai.dev
   cd ~/secureai-deepfake-detection
   mkdir -p secrets
   ```

2. **Upload the file:**
   - In DigitalOcean console, go to your droplet
   - Click "Access" → "Launch Droplet Console"
   - Or use the file upload feature if available
   - Or copy/paste the contents:
     ```bash
     nano secrets/x_cookies.txt
     # Paste your cookies content here
     # Press Ctrl+X, then Y, then Enter to save
     ```

### Step 3: Verify Cookies File Format

The cookies file should be in Netscape format (used by `yt-dlp`). It should look like:

```
# Netscape HTTP Cookie File
# This file was generated by cookies.txt extension
x.com	TRUE	/	FALSE	1735689600	session_id	abc123...
x.com	TRUE	/	FALSE	1735689600	auth_token	xyz789...
```

**Important:** Make sure the file:
- Has proper domain entries (x.com, .x.com, twitter.com, .twitter.com)
- Contains authentication cookies (not just session cookies)
- Is in Netscape format (tab-separated)

### Step 4: Set File Permissions

```bash
# On your server
chmod 600 secrets/x_cookies.txt  # Only owner can read/write
chown root:root secrets/x_cookies.txt  # Or app:app if using app user
```

### Step 5: Update Docker Compose Configuration

The `docker-compose.https.yml` should already have the volume mount configured. Verify it:

```bash
# Check if the volume mount exists
grep -A 5 "secrets" docker-compose.https.yml
```

It should show:
```yaml
volumes:
  - ./secrets:/app/secrets:ro
```

And in environment:
```yaml
environment:
  - X_COOKIES_FILE=/app/secrets/x_cookies.txt
```

If it's not there, add it:

```bash
# Edit docker-compose.https.yml
nano docker-compose.https.yml
```

Add to `secureai-backend` service:
```yaml
secureai-backend:
  # ... existing config ...
  environment:
    # ... existing env vars ...
    - X_COOKIES_FILE=/app/secrets/x_cookies.txt
  volumes:
    # ... existing volumes ...
    - ./secrets:/app/secrets:ro
```

### Step 6: Restart Backend Service

```bash
# SSH into your server
ssh root@guardian.secureai.dev

cd ~/secureai-deepfake-detection

# Restart backend to pick up new environment variable
docker compose -f docker-compose.https.yml up -d --force-recreate secureai-backend

# Verify it's running
docker ps | grep secureai-backend

# Check logs to ensure no errors
docker logs secureai-backend --tail 50
```

### Step 7: Test the Configuration

#### Test 1: Verify cookies file is accessible in container

```bash
# Check if file exists in container
docker exec secureai-backend ls -la /app/secrets/x_cookies.txt

# Check if environment variable is set
docker exec secureai-backend env | grep X_COOKIES_FILE
```

Should show:
```
X_COOKIES_FILE=/app/secrets/x_cookies.txt
```

#### Test 2: Test X link analysis

1. **Open SecureAI Guardian:** https://guardian.secureai.dev
2. **Go to STREAM_INTEL tab**
3. **Paste an X link** (e.g., `https://x.com/username/status/1234567890`)
4. **Click "Authorize Multi-Layer Analysis"**
5. **Should work without errors!**

#### Test 3: Check backend logs

```bash
# Watch logs during analysis
docker logs -f secureai-backend
```

You should see:
- Video download starting
- No authentication errors
- Analysis proceeding normally

### Step 8: Troubleshooting

#### Issue: "X_AUTH_REQUIRED" error still appears

**Check:**
1. Cookies file exists: `ls -la secrets/x_cookies.txt`
2. Environment variable is set: `docker exec secureai-backend env | grep X_COOKIES`
3. File is readable: `docker exec secureai-backend cat /app/secrets/x_cookies.txt | head -5`
4. Backend was restarted after adding the file

**Fix:**
```bash
# Restart backend
docker compose -f docker-compose.https.yml restart secureai-backend
```

#### Issue: "Failed to download video" error

**Possible causes:**
1. Cookies expired (X cookies typically expire after 30 days)
2. Cookies file format is incorrect
3. Missing required cookies

**Fix:**
1. Re-export cookies from browser (make sure you're logged in)
2. Re-upload to server
3. Restart backend

#### Issue: Cookies file not found in container

**Check:**
1. File exists on host: `ls -la ~/secureai-deepfake-detection/secrets/x_cookies.txt`
2. Volume mount is correct in docker-compose.https.yml
3. File permissions are correct: `chmod 600 secrets/x_cookies.txt`

**Fix:**
```bash
# Ensure directory exists
mkdir -p secrets

# Set correct permissions
chmod 600 secrets/x_cookies.txt

# Restart container
docker compose -f docker-compose.https.yml up -d --force-recreate secureai-backend
```

### Step 9: Maintain Cookies (Important!)

**X cookies expire after ~30 days.** We've automated the checking and reminders, but you still need to manually export and upload cookies.

#### Automated Features (Setup Once)

Run this setup script to enable automated cookie monitoring:

```bash
cd ~/secureai-deepfake-detection
bash scripts/setup_cookie_automation.sh
```

This sets up:
- **Daily cookie expiration check** (9 AM) - checks if cookies are expired or expiring soon
- **Monthly reminder** (1st of month, 9 AM) - reminds you to refresh cookies
- **Logs** saved to `logs/cookie_check.log`

#### Manual Steps (Monthly)

**Cannot be automated** - requires browser interaction:

1. **Export cookies from browser:**
   - Go to https://x.com (logged in)
   - Click extension → Export
   - Save as `x_cookies.txt`

2. **Upload to server:**
   ```bash
   # From your local computer
   scp x_cookies.txt root@guardian.secureai.dev:/tmp/x_cookies.txt
   ```

3. **Update on server:**
   ```bash
   # On server
   cd ~/secureai-deepfake-detection
   bash scripts/update_x_cookies.sh /tmp/x_cookies.txt
   ```

The `update_x_cookies.sh` script will:
- Backup old cookies
- Copy new cookies
- Set correct permissions
- Verify cookies are valid
- Restart backend automatically

#### Check Cookie Status

```bash
# Check if cookies are expired or expiring soon
python3 scripts/check_cookie_expiration.py

# View cookie check logs
tail -f logs/cookie_check.log
```

## Security Considerations

1. **Keep cookies file secure:**
   - Use `chmod 600` (only owner can read)
   - Don't commit to git (should be in .gitignore)
   - Don't share publicly

2. **Rotate cookies regularly:**
   - Export fresh cookies monthly
   - Revoke old sessions if possible

3. **Monitor usage:**
   - Check backend logs for authentication errors
   - Set up alerts for failed downloads

## Verification Checklist

- [ ] Cookies file exported from browser
- [ ] Cookies file uploaded to server at `secrets/x_cookies.txt`
- [ ] File permissions set to `600`
- [ ] `X_COOKIES_FILE` environment variable set in docker-compose
- [ ] Volume mount configured in docker-compose
- [ ] Backend restarted
- [ ] Environment variable verified in container
- [ ] Test X link analysis works
- [ ] No errors in backend logs

## Next Steps

Once configured:
1. Users can paste X links directly in SecureAI Guardian
2. No need for Chrome extension
3. Server handles authentication automatically
4. Works for all users (not just the one who exported cookies)

## Support

If you encounter issues:
1. Check backend logs: `docker logs secureai-backend`
2. Verify cookies file format
3. Test cookies manually: `yt-dlp --cookies secrets/x_cookies.txt "https://x.com/username/status/123"`
4. Check X account is still logged in
